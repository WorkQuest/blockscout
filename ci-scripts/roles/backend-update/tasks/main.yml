---
- name: Delete dir
  file:
    path: '{{ BACKEND_BIN }}'
    state: absent

- name: Create dir
  file:
    path: '{{ BACKEND_BIN }}'
    state: directory
    recurse: yes

- name: Upload files
  synchronize:
    src: '{{ SRC_DIR }}'
    dest: '{{ BACKEND_BIN }}'
  register: copyfiles

- name: Install epel-release
  dnf:
    name: epel-release
    state: latest
  become: yes

- name: Install erlang repo
  dnf:
    name: https://packages.erlang-solutions.com/erlang-solutions-2.0-1.noarch.rpm
    state: present

- name: Install esl-erlang and unzip
  dnf:
    name: 
      - esl-erlang 
      - unzip
    state: latest

- name: Copy explorer.service file
  copy:
    src: ./install-erlang-elixir-el8.sh
    dest: '{{ BACKEND_BIN }}/install-erlang-elixir-el8.sh'

- name: Install Erlang and Elexir
  ansible.builtin.script: '{{ BACKEND_BIN }}/install-erlang-elixir-el8.sh'

- name: Environments
  shell: | 
     echo ${{ PATH }}
     echo ${{ FIRST_BLOCK }}
     echo ${{ DATABASE_URL }}
     echo ${{ SECRET_KEY_BASE }}
     echo ${{ CHAIN_SPEC_PATH }}
     echo ${{ COIN }}
     echo ${{ CHAIN_ID }}
     echo ${{ NETWORK }}
     echo ${{ SUBNETWORK }}
     echo ${{ ETHEREUM_JSONRPC_HTTP_URL }}

- name: Copy service file
  template:
    src: './{{ APPS }}'
    dest: '/etc/systemd/system/{{ APPS }}'

- name: Migrate database
  shell: mix do ecto.migrate
  args:
    chdir: '{{ BACKEND_BIN }}/apps/indexer'
  ignore_errors: yes