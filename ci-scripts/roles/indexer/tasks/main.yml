---
- name: Delete dir
  file:
    path: '{{ BACKEND_BIN }}'
    state: absent

- name: Create dir
  file:
    path: '{{ BACKEND_BIN }}'
    state: directory
    recurse: yes

- name: Upload files
  synchronize:
    src: '{{ SRC_DIR }}'
    dest: '{{ BACKEND_BIN }}'
  register: copyfiles

- name: Install epel-release
  dnf:
    name: epel-release
    state: latest
  become: yes

- name: Install NodeJs repositories
  shell: curl -sL https://rpm.nodesource.com/setup_16.x | sudo -E bash -
  register: result

- name: Install dependens Blockscout
  dnf:
    name:
      - Nodejs
      - automake
      - inotify-tools
      - libtool
      - inotify-tools
      - gcc
      - gmp
      - cargo
    state: latest
  become: yes

- name: Copy script to install Erlang and elixir
  copy:
    src: install-erlang-elixir-el8.sh
    dest: '{{ BACKEND_BIN }}/install-erlang-elixir-el8.sh'
    owner: '{{ REMOTE_USER }}'
    group: '{{ REMOTE_USER }}'
    mode: u+rwx

- name: Install Erlang and Elexir
  shell: '{{ BACKEND_BIN }}/install-erlang-elixir-el8.sh'
  become: yes

- name: Environments
  shell: | 
     echo ${{ PATH }}
     echo ${{ FIRST_BLOCK }}
     echo ${{ DATABASE_URL }}
     echo ${{ SECRET_KEY_BASE }}
     echo ${{ CHAIN_SPEC_PATH }}
     echo ${{ COIN }}
     echo ${{ CHAIN_ID }}
     echo ${{ NETWORK }}
     echo ${{ SUBNETWORK }}
     echo ${{ ETHEREUM_JSONRPC_HTTP_URL }}
     echo ${{ ETHEREUM_JSONRPC_VARIANT }}
     export ${{ TEST }}
  became: yes
  becam_user: '{{ REMOTE_USER }}'

- name: Copy service file
  copy:
    src: '{{ APPS }}'
    dest: '/etc/systemd/system/{{ APPS }}'
    owner: '{{ REMOTE_USER }}'
    group: '{{ REMOTE_USER }}'
    mode: u+rx
  become: yes

- name: Create database
  shell: mix do ecto.create
  args:
    chdir: '{{ BACKEND_BIN }}/apps/indexer'
  ignore_errors: yes

- name: Migrate database
  shell: mix do ecto.migrate
  args:
    chdir: '{{ BACKEND_BIN }}/apps/indexer'
  ignore_errors: yes